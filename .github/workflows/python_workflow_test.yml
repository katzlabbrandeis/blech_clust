# GitHub Actions workflow for automated testing
# See: https://docs.github.com/en/actions
#
# This workflow runs Python tests on a self-hosted runner
# Jobs are independent to allow partial success/failure reporting

name: Python test
run-name: python_test
on:
  pull_request:
  workflow_dispatch:
jobs:
  Preamble:
    runs-on: self-hosted
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - name: Clean workspace
        run: |
          echo "Cleaning workspace to ensure fresh checkout"
          rm -rf ${{ github.workspace }}/*
          rm -rf ${{ github.workspace }}/.git
          rm -rf ${{ github.workspace }}/.github

      - run: pwd
      - run: which python
      - run: conda info --envs

      - name: Set up repo
        uses: actions/checkout@v4

      - run: git status
      - run: echo "${{ github.ref }} | ${{ github.repository }} | ${{ github.event.pull_request.title }}"

      - name: check labels
        run: echo "${{ github.event.pull_request.labels.*.name }}"

      - name: Check files in working-directory
        run: ls -lFR ${{ github.workspace }} 

      - name: Install blech_clust package
        run: make core optional prefect dev

      - name: Check params
        run: for f in $(find ${{ github.workspace }}/params/ -type f); do echo $f; cat $f; done

  Spike-EMG:
    runs-on: self-hosted
    needs: Preamble
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    # Test full pipeline with both spike sorting and EMG analysis
    steps:
      - name: Prefect SPIKE then EMG test
        shell: bash
        run: LOG_LOC="{{ github.workspace }}/github.log"; \
              conda run -n blech_clust python pipeline_testing/prefect_pipeline.py --spike-emg --silent 2>&1 | tee ${LOG_LOC}; \
              if grep -q "ERROR" ${LOG_LOC}; then \
                echo "ERROR detected by bash";
                ./pipeline_testing/extract_traceback.sh ${LOG_LOC}; 
                exit 1;
              fi
  EMG-Only:
    runs-on: self-hosted
    needs: Spike-EMG
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    # Test EMG analysis pipeline in isolation
    steps:
      - name: Prefect EMG only test
        shell: bash
        run: conda run -n blech_clust python pipeline_testing/prefect_pipeline.py -e --silent 2>&1 | tee ${LOG_LOC}; \
              if grep -q "ERROR" ${LOG_LOC}; then \
                echo "ERROR detected by bash";
                ./pipeline_testing/extract_traceback.sh ${LOG_LOC}; 
                exit 1;
              fi
